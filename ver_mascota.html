<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoviVital - Tu Mascota</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f2f2f2;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #4a4aff;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .container {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        .mascot-display {
            background-color: #d9f7f6;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            width: 90%;
            max-width: 350px;
        }
        .mascot-display img {
            width: 100%;
            max-width: 250px;
            height: auto;
            display: block;
            margin: 0 auto 1rem auto;
        }
        .mascot-display h2 {
            color: #4a4aff;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }
        .progreso-section {
            width: 90%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }
        .barra-progreso {
            background-color: #ccc;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .barra-progreso-inner {
            display: block;
            height: 100%;
            width: 0%;
            background-color: #15a858;
            border-radius: 12px;
            transition: width 0.5s ease-in-out;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .btn-volver {
            background-color: #4a4aff;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-volver:hover {
            background-color: #3a3abf;
        }
        .selector-mascotas-cuadro {
            background-color: #fff;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .selector-mascotas-cuadro h3 {
            margin-bottom: 1rem;
            color: #4a4aff;
        }
        .selector-mascotas {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
        }
        .selector-mascotas .mascota-item {
            text-align: center;
        }
        .selector-mascotas img {
            width: 100px;
            height: auto;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
        }
        .selector-mascotas img.selected {
            border-color: #4a4aff;
            transform: scale(1.1);
        }
        .selector-mascotas p {
            margin-top: 0.3rem;
            font-size: 0.85rem;
        }
        .input-nombre {
            margin: 1rem 0;
        }
        .input-nombre input {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            width: 80%;
        }
    </style>
</head>
<body>
<header>Tu Compañero MoviVital</header>
<div class="container">
    <div id="mascot-selector-box" class="selector-mascotas-cuadro">
        <h3>Elige tu mascota</h3>
        <div id="mascot-selector" class="selector-mascotas">
            <div class="mascota-item">
                <img src="Mascota_i.png" alt="Mascota 1" data-filename="Mascota_i.png" onclick="elegirMascota(this)">
            </div>
            <div class="mascota-item">
                <img src="mascota_o.png" alt="Mascota 2" data-filename="mascota_o.png" onclick="elegirMascota(this)">
            </div>
            <div class="mascota-item">
                <img src="mascota_k.png" alt="Mascota 3" data-filename="mascota_k.png" onclick="elegirMascota(this)">
            </div>
            <div class="mascota-item">
                <img src="mascota_c.png" alt="Mascota 4" data-filename="mascota_c.png" onclick="elegirMascota(this)">
            </div>
        </div>
        <div class="input-nombre">
            <input type="text" id="mascot-custom-name" placeholder="Escribe el nombre de tu mascota" oninput="guardarNombreMascota()">
        </div>
    </div>

    <div class="mascot-display">
        <h2>¡Hola, <span id="mascot-name"></span>!</h2>
        <img id="mascot-image" src="" alt="Tu Mascota">
        <p id="mascot-message">Sigue ejercitándote para ayudarla a crecer.</p>
    </div>

    <div class="progreso-section">
        <p>Progreso Total de Ejercicios:</p>
        <div class="barra-progreso">
            <div class="barra-progreso-inner" id="progress-bar-inner">0%</div>
        </div>
        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #777;">
            Ejercicios completados: <span id="exercise-count-display">0</span>
        </p>
    </div>

    <button class="btn-volver" onclick="window.history.back()">Volver a la App</button>
</div>

<script>
    const MAX_EXERCISES = 10;

    // Define las etapas de evolución de la mascota
    // IMPORTANT: Ensure these paths are correct relative to your HTML file
    // If your "stage" images are in an 'img' folder, keep 'img/'
    const mascotStages = [
        { threshold: 0, image: 'img/mascota_stage1.png', message: '¡Tu mascota es un retoño! Sigue ejercitándote para que crezca fuerte.' },
        { threshold: 3, image: 'img/mascota_stage2.png', message: '¡Tu mascota está en crecimiento! ¡Vamos por más ejercicios!' },
        { threshold: 6, image: 'img/mascota_stage3.png', message: '¡Tu mascota es una adulta vital! ¡Estás haciendo un gran trabajo!' },
        { threshold: 10, image: 'img/mascota_stage4.png', message: '¡Felicidades! Tu mascota ha alcanzado su máximo potencial. ¡Eres un campeón!' }
    ];

    function updateMascotAndProgress() {
        let exerciseCount = parseInt(localStorage.getItem('movivital_exercise_count') || '0', 10);
        let selectedMascotFileName = localStorage.getItem('movivital_mascot'); // Get the stored selected mascot filename
        let customName = localStorage.getItem('movivital_mascot_name'); // Get the stored custom name

        // --- FIX: Ensure a default selectedMascotFileName if none is stored ---
        if (!selectedMascotFileName) {
            selectedMascotFileName = 'mascota_c.png'; // Default if nothing chosen yet
            localStorage.setItem('movivital_mascot', selectedMascotFileName); // Store default
        }

        // --- FIX: Default name logic refined ---
        // If no custom name is set, use the filename as default name (without extension)
        if (!customName || customName.trim() === '') {
            customName = selectedMascotFileName.split('.')[0];
            localStorage.setItem('movivital_mascot_name', customName); // Store this default name
        }

        document.getElementById('mascot-name').textContent = customName;
        document.getElementById('exercise-count-display').textContent = exerciseCount;

        // Calculate and update progress bar
        let progressPercentage = (exerciseCount / MAX_EXERCISES) * 100;
        if (progressPercentage > 100) progressPercentage = 100;

        const progressBar = document.getElementById('progress-bar-inner');
        progressBar.style.width = progressPercentage + '%';
        progressBar.textContent = Math.round(progressPercentage) + '%';

        // Determine current evolution stage based on exercise progress
        let currentStage = mascotStages[0];
        for (let i = mascotStages.length - 1; i >= 0; i--) {
            if (exerciseCount >= mascotStages[i].threshold) {
                currentStage = mascotStages[i];
                break;
            }
        }
        
        const mascotImageElement = document.getElementById('mascot-image');
        let imageToDisplay = selectedMascotFileName; // Start with the user's selected mascot

        // Extract just the filename for comparison (e.g., "Mascota_i.png" from "path/to/Mascota_i.png")
        const getFileNameFromPath = (path) => path.substring(path.lastIndexOf('/') + 1);

        const selectedMascotBaseName = getFileNameFromPath(selectedMascotFileName);
        const currentStageBaseName = getFileNameFromPath(currentStage.image);

        // --- CRITICAL FIX FOR IMAGE DISPLAY LOGIC ---
        // The image should be the selected one, UNLESS the exercise count mandates an evolution
        // AND the selected base image is NOT the same as the current stage image.
        // This means if you select 'Mascota_i.png' and stage1 is 'mascota_stage1.png',
        // and you're at threshold 0, it will display 'Mascota_i.png'.
        // It only changes if exerciseCount >= currentStage.threshold AND the filenames differ.
        if (exerciseCount >= currentStage.threshold && selectedMascotBaseName !== currentStageBaseName) {
            imageToDisplay = currentStage.image;
        } else if (exerciseCount >= currentStage.threshold && selectedMascotBaseName === currentStageBaseName) {
            // If the selected mascot IS one of the stage mascots and you've reached that stage,
            // then display the stage mascot (this handles cases where a user might select
            // one of the evolution images as their base mascot).
            imageToDisplay = currentStage.image;
        } else {
            // If exercise count is below the first threshold (0), or not at an evolution stage,
            // always show the user's selected base mascot.
            imageToDisplay = selectedMascotFileName;
        }


        // Set the actual image source
        mascotImageElement.src = imageToDisplay; 

        // Update the mascot message based on the current stage
        document.getElementById('mascot-message').textContent = currentStage.message;

        // Synchronize the custom name input field
        document.getElementById('mascot-custom-name').value = customName;

        // Highlight the selected mascot in the selector
        document.querySelectorAll('.selector-mascotas img').forEach(img => {
            img.classList.remove('selected');
            if (img.dataset.filename === selectedMascotFileName) {
                img.classList.add('selected');
            }
        });
    }

    function elegirMascota(selectedImageElement) {
        // Remove 'selected' class from all images
        document.querySelectorAll('.selector-mascotas img').forEach(img => {
            img.classList.remove('selected');
        });

        // Add 'selected' class to the clicked image
        selectedImageElement.classList.add('selected');

        const mascotFileName = selectedImageElement.dataset.filename;
        localStorage.setItem('movivital_mascot', mascotFileName);
        
        // --- FIX: Default name logic when choosing a new mascot ---
        // Only update the custom name input if it was previously empty or was the old default filename
        let currentCustomName = localStorage.getItem('movivital_mascot_name');
        let newDefaultName = mascotFileName.split('.')[0];

        if (!currentCustomName || currentCustomName.trim() === '' || currentCustomName === document.getElementById('mascot-name').textContent) {
            document.getElementById('mascot-custom-name').value = newDefaultName;
            localStorage.setItem('movivital_mascot_name', newDefaultName);
        }
        
        updateMascotAndProgress(); // Update the main display
    }

    function guardarNombreMascota() {
        const nombre = document.getElementById('mascot-custom-name').value;
        localStorage.setItem('movivital_mascot_name', nombre);
        // Update the displayed name immediately
        document.getElementById('mascot-name').textContent = nombre;
    }

    // This runs when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('mascot-selector-box').style.display = 'block';
        
        // Ensure initial setup even if localStorage is empty
        // updateMascotAndProgress will handle setting a default if needed
        updateMascotAndProgress(); 
    });
</script>
